<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Test Google Register & Login</title>
  </head>
  <body>
    <h2>Test Register, Login, Refresh & Logout Backend (Google OAuth)</h2>

    <button id="btnRegister">Register with Google</button>
    <button id="btnLogin">Login with Google</button>
    <button id="btnRefresh">Refresh Token</button>
    <button id="btnLogout">Logout</button>

    <pre id="result"></pre>

    <!-- Firebase v9 compat -->
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-auth-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBlTNBTsDwplBVXket4TPUTMVlanb2HHxk",
        authDomain: "auth-e820e.firebaseapp.com",
        projectId: "auth-e820e",
        storageBucket: "auth-e820e.firebasestorage.app",
        messagingSenderId: "561674401648",
        appId: "1:561674401648:web:f19d09199fea6f51f041b5",
        measurementId: "G-8SV4DM3YLV",
      };

      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();

      // Simpan token sementara di memory
      let accessToken = "";
      let refreshToken = "";

      async function loginGooglePopup() {
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await auth.signInWithPopup(provider);
        return await result.user.getIdToken();
      }

      // -------------------- REGISTER ------------------------
      document.getElementById("btnRegister").onclick = async function () {
        try {
          const idToken = await loginGooglePopup();

          const res = await fetch(
            "http://localhost:8080/api/auth/admin/register",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id_token: idToken }),
            }
          );

          const json = await res.json();
          document.getElementById("result").innerText =
            "RESPONSE REGISTER:\n\n" + JSON.stringify(json, null, 2);
        } catch (e) {
          document.getElementById("result").innerText = e.message;
        }
      };

      // -------------------- LOGIN ------------------------
      document.getElementById("btnLogin").onclick = async function () {
        try {
          const idToken = await loginGooglePopup();
          const deviceInfo = navigator.userAgent;

          const res = await fetch(
            "http://localhost:8080/api/auth/admin/login",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                id_token: idToken,
                device_info: deviceInfo,
              }),
            }
          );

          const json = await res.json();

          // simpan token
          accessToken = json.token;
          refreshToken = json.refresh;

          document.getElementById("result").innerText =
            "RESPONSE LOGIN:\n\n" + JSON.stringify(json, null, 2);
        } catch (e) {
          document.getElementById("result").innerText = e.message;
        }
      };

      // -------------------- REFRESH TOKEN ------------------------
      document.getElementById("btnRefresh").onclick = async function () {
        if (!refreshToken) {
          alert("Login dulu sebelum refresh token!");
          return;
        }

        try {
          const res = await fetch(
            "http://localhost:8080/api/auth/admin/refresh",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ refresh_token: refreshToken }),
            }
          );

          const json = await res.json();

          // update token
          accessToken = json.access_token;
          refreshToken = json.refresh_token;

          document.getElementById("result").innerText =
            "RESPONSE REFRESH:\n\n" + JSON.stringify(json, null, 2);
        } catch (e) {
          document.getElementById("result").innerText = e.message;
        }
      };

      // -------------------- LOGOUT ------------------------
      document.getElementById("btnLogout").onclick = async function () {
        if (!refreshToken) {
          alert("Login dulu sebelum logout!");
          return;
        }

        try {
          const res = await fetch(
            "http://localhost:8080/api/auth/admin/logout",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + accessToken,
              },
              body: JSON.stringify({ refresh_token: refreshToken }),
            }
          );

          const json = await res.json();

          // clear tokens
          accessToken = "";
          refreshToken = "";

          document.getElementById("result").innerText =
            "RESPONSE LOGOUT:\n\n" + JSON.stringify(json, null, 2);
        } catch (e) {
          document.getElementById("result").innerText = e.message;
        }
      };
    </script>
  </body>
</html>
